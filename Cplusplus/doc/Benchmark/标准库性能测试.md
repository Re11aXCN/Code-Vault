# C++23 控制台输出性能测试报告

## 测试目的

本测试旨在全面比较 C++ 中各种输出方法在不同数据类型下的性能表现，包括：
- `puts` / `printf`（C 风格）
- `cout`（C++ 标准，分别测试 `\n` 和 `std::endl`）
- C++23 `std::print`（新特性）
- 平台特定 API（Windows：`WriteConsole`，macOS/Linux：`write`）

## 测试代码概述

### 核心特性
- **数据类型覆盖**：基本类型（int, double）、字符串、混合类型、自定义类型
- **刷新策略**：统一处理输出刷新，特别对比 `\n` 与 `std::endl`
- **跨平台支持**：Windows 和 Unix-like 系统兼容
- **条件编译**：根据编译器支持情况启用 C++23 `std::print`

### 关键代码结构
```cpp
class PerformanceTester {
private:
    static constexpr int ITERATIONS = 10000;
    // 测试数据定义
    // 结果收集机制
public:
    void run_all_tests();
private:
    // 各种测试方法...
    template<typename Func>
    double measure_time(Func&& func, const std::string& test_name);
};
```

### 详细代码

```c++
#include <iostream>
#include <string>
#include <string_view>
#include <chrono>
#include <format>
#include <vector>
#include <cstdio>
#include <cstring>
#include <fstream>

#ifdef _WIN32
#include <windows.h>
#else
#include <unistd.h>
#endif

// C++23 print 特性检查
#ifdef __has_include
#if __has_include(<print>)
#include <print>
#define HAS_STD_PRINT 1
#else
#define HAS_STD_PRINT 0
#endif
#else
#define HAS_STD_PRINT 0
#endif

// 自定义数据类型
struct Person {
    std::string name;
    int age;
    double salary;

    Person(std::string n, int a, double s) : name(std::move(n)), age(a), salary(s) {}
};

// 为自定义类型提供 format 特化
template<>
struct std::formatter<Person> {
    constexpr auto parse(std::format_parse_context& ctx) {
        return ctx.begin();
    }

    auto format(const Person& p, std::format_context& ctx) const {
        return std::format_to(ctx.out(), "Person{{name: {}, age: {}, salary: {:.2f}}}",
            p.name, p.age, p.salary);
    }
};

class PerformanceTester {
private:
    static constexpr int ITERATIONS = 10000;
    static constexpr int WARMUP_ITERATIONS = 1000;

    // 测试数据
    const int test_int = 42;
    const double test_double = 3.141592653589793;
    const std::string test_string = "Hello, World!";
    const std::string_view test_string_view = "String View Test";
    const char* test_cstring = "C-Style String";
    const Person test_person{ "Alice", 30, 50000.50 };
    const std::vector<int> test_vector{ 1, 2, 3, 4, 5 };

    // 结果收集
    std::vector<std::pair<std::string, double>> results;

public:
    void run_all_tests() {
        std::cout << "C++23 控制台输出性能测试 (" << ITERATIONS << " 次迭代)\n";
        std::cout << "========================================\n";

        // 预热
        warmup();

        // 基本数据类型测试
        test_basic_types();

        // 复杂数据类型测试
        test_complex_types();

        // 自定义数据类型测试
        test_custom_types();

        // 显示结果
        print_results();

        std::cout << "========================================\n";
    }

private:
    void warmup() {
#ifdef REDIRECT_OUTPUT
        /*// 重定向输出到空设备进行预热，避免控制台输出干扰
        std::ofstream buffer;
#ifdef _WIN32
        buffer.open("NUL");
#else
        buffer.open("/dev/null");
#endif*/
		// 或者需要打印数据，重定向到stringstream
        std::stringstream buffer;  // 用于捕获输出的缓冲区
        auto old_cout_buf = std::cout.rdbuf();
        std::cout.rdbuf(buffer.rdbuf());
#endif // REDIRECT_OUTPUT
        for (int i = 0; i < WARMUP_ITERATIONS; ++i) {
            std::cout << "Warmup " << i << "\n";
        }
#ifdef REDIRECT_OUTPUT
        // 恢复cout
        std::cout.rdbuf(old_cout_buf);
        // 获取捕获的输出内容
        std::string captured_output = buffer.str();
        std::cout << captured_output;
#endif // REDIRECT_OUTPUT
        std::cout.flush();
    }

    template<typename Func>
    double measure_time(Func&& func, const std::string& test_name) {

#ifdef REDIRECT_OUTPUT
        /*
        std::ofstream buffer;
#ifdef _WIN32
        buffer.open("NUL");
#else
        buffer.open("/dev/null");
#endif*/
        std::stringstream buffer;
        auto old_cout_buf = std::cout.rdbuf();
        std::cout.rdbuf(buffer.rdbuf());
#endif // REDIRECT_OUTPUT
        auto start = std::chrono::high_resolution_clock::now();
        func();
        // 测试std::cout时、重定向输出，最终打印结果，需要将这个过程进行计时
        // 否则可以一道end 计时之后
#ifdef REDIRECT_OUTPUT
        std::cout.rdbuf(old_cout_buf);
        std::string captured_output = buffer.str();
        std::cout << captured_output;
#endif // REDIRECT_OUTPU
        auto end = std::chrono::high_resolution_clock::now();
        std::chrono::duration<double, std::milli> duration = end - start;
        results.emplace_back(test_name, duration.count());
        return duration.count();
    }

    void test_basic_types() {
        std::cout << "\n--- 基本数据类型测试 ---\n";

        // int 测试
        measure_time([this]() { test_puts_int(); }, "puts (int)");
        measure_time([this]() { test_printf_int(); }, "printf (int)");
        measure_time([this]() { test_cout_int_n(); }, "cout (int, \\n)");
        measure_time([this]() { test_cout_int_endl(); }, "cout (int, endl)");
        measure_time([this]() { test_write_console_int(); }, "WriteConsole/write (int)");
#if HAS_STD_PRINT
        measure_time([this]() { test_print_int(); }, "std::print (int)");
#endif

        // double 测试
        measure_time([this]() { test_puts_double(); }, "puts (double)");
        measure_time([this]() { test_printf_double(); }, "printf (double)");
        measure_time([this]() { test_cout_double_n(); }, "cout (double, \\n)");
        measure_time([this]() { test_cout_double_endl(); }, "cout (double, endl)");
        measure_time([this]() { test_write_console_double(); }, "WriteConsole/write (double)");
#if HAS_STD_PRINT
        measure_time([this]() { test_print_double(); }, "std::print (double)");
#endif
    }

    void test_complex_types() {
        std::cout << "\n--- 复杂数据类型测试 ---\n";

        // string 测试
        measure_time([this]() { test_puts_string(); }, "puts (string)");
        measure_time([this]() { test_printf_string(); }, "printf (string)");
        measure_time([this]() { test_cout_string_n(); }, "cout (string, \\n)");
        measure_time([this]() { test_cout_string_endl(); }, "cout (string, endl)");
        measure_time([this]() { test_write_console_string(); }, "WriteConsole/write (string)");
#if HAS_STD_PRINT
        measure_time([this]() { test_print_string(); }, "std::print (string)");
#endif

        // 混合类型测试
        measure_time([this]() { test_printf_mixed(); }, "printf (mixed)");
        measure_time([this]() { test_cout_mixed_n(); }, "cout (mixed, \\n)");
        measure_time([this]() { test_cout_mixed_endl(); }, "cout (mixed, endl)");
        measure_time([this]() { test_write_console_mixed(); }, "WriteConsole/write (mixed)");
#if HAS_STD_PRINT
        measure_time([this]() { test_print_mixed(); }, "std::print (mixed)");
#endif
    }

    void test_custom_types() {
        std::cout << "\n--- 自定义数据类型测试 ---\n";

        measure_time([this]() { test_cout_custom_n(); }, "cout (custom, \\n)");
        measure_time([this]() { test_cout_custom_endl(); }, "cout (custom, endl)");
        measure_time([this]() { test_write_console_custom(); }, "WriteConsole/write (custom)");
#if HAS_STD_PRINT
        measure_time([this]() { test_print_custom(); }, "std::print (custom)");
#endif
    }

    void print_results() {
        std::cout << "\n--- 性能测试结果 (按时间排序) ---\n";

        // 按时间排序
        std::sort(results.begin(), results.end(),
            [](const auto& a, const auto& b) { return a.second < b.second; });

        // 找到最快的时间用于计算相对性能
        double fastest = results[0].second;

        for (const auto& [name, time] : results) {
            double relative = time / fastest;
            std::cout << std::format("{:<30}: {:8.3f} ms (x{:.2f})\n", name, time, relative);
        }

        // 按类别分组显示
        std::cout << "\n--- 按输出方式统计 ---\n";
        print_statistics_by_type();
    }

    void print_statistics_by_type() {
        std::vector<std::string> types = { "puts", "printf", "cout(\\n)", "cout(endl)",
                                         "WriteConsole/write", "std::print" };
        std::vector<std::string> target = { "ts", "tf", "n)", "l)",
                                         "te", "::" };
        int i = 0;
        for (const auto& type : types) {
            double total_time = 0;
            int count = 0;

            for (const auto& [name, time] : results) {
                if (name.find(target[i]) != std::string::npos) {
                    total_time += time;
                    count++;
                }
            }
            

            if (count > 0) {
                std::cout << std::format("{:<20}: {:8.3f} ms (平均)\n", type, total_time / count);
            }
            ++i;
        }
    }

    // int 测试函数
    void test_puts_int() {
        for (int i = 0; i < ITERATIONS; ++i) {
            char buffer[32];
            std::snprintf(buffer, sizeof(buffer), "%d\n", test_int);
            puts(buffer);
        }
    }

    void test_printf_int() {
        for (int i = 0; i < ITERATIONS; ++i) {
            printf("%d\n", test_int);
        }
        fflush(stdout);
    }

    void test_cout_int_n() {
        for (int i = 0; i < ITERATIONS; ++i) {
            std::cout << test_int << '\n';
        }
        std::cout.flush();
    }

    void test_cout_int_endl() {
        for (int i = 0; i < ITERATIONS; ++i) {
            std::cout << test_int << std::endl;
        }
    }

    void test_write_console_int() {
        for (int i = 0; i < ITERATIONS; ++i) {
            std::string output = std::format("{}\n", test_int);
            write_output(output);
        }
    }

#if HAS_STD_PRINT
    void test_print_int() {
        for (int i = 0; i < ITERATIONS; ++i) {
            std::print("{}\n", test_int);
        }
    }
#endif

    // double 测试函数
    void test_puts_double() {
        for (int i = 0; i < ITERATIONS; ++i) {
            char buffer[32];
            std::snprintf(buffer, sizeof(buffer), "%.6f\n", test_double);
            puts(buffer);
        }
    }

    void test_printf_double() {
        for (int i = 0; i < ITERATIONS; ++i) {
            printf("%.6f\n", test_double);
        }
        fflush(stdout);
    }

    void test_cout_double_n() {
        for (int i = 0; i < ITERATIONS; ++i) {
            std::cout << test_double << '\n';
        }
        std::cout.flush();
    }

    void test_cout_double_endl() {
        for (int i = 0; i < ITERATIONS; ++i) {
            std::cout << test_double << std::endl;
        }
    }

    void test_write_console_double() {
        for (int i = 0; i < ITERATIONS; ++i) {
            std::string output = std::format("{:.6f}\n", test_double);
            write_output(output);
        }
    }

#if HAS_STD_PRINT
    void test_print_double() {
        for (int i = 0; i < ITERATIONS; ++i) {
            std::print("{:.6f}\n", test_double);
        }
    }
#endif

    // string 测试函数
    void test_puts_string() {
        for (int i = 0; i < ITERATIONS; ++i) {
            puts(test_cstring);
        }
    }

    void test_printf_string() {
        for (int i = 0; i < ITERATIONS; ++i) {
            printf("%s\n", test_cstring);
        }
        fflush(stdout);
    }

    void test_cout_string_n() {
        for (int i = 0; i < ITERATIONS; ++i) {
            std::cout << test_string << '\n';
        }
        std::cout.flush();
    }

    void test_cout_string_endl() {
        for (int i = 0; i < ITERATIONS; ++i) {
            std::cout << test_string << std::endl;
        }
    }

    void test_write_console_string() {
        for (int i = 0; i < ITERATIONS; ++i) {
            std::string output = test_string + "\n";
            write_output(output);
        }
    }

#if HAS_STD_PRINT
    void test_print_string() {
        for (int i = 0; i < ITERATIONS; ++i) {
            std::print("{}\n", test_string);
        }
    }
#endif

    // 混合类型测试函数
    void test_printf_mixed() {
        for (int i = 0; i < ITERATIONS; ++i) {
            printf("Int: %d, Double: %.2f, String: %s\n",
                test_int, test_double, test_cstring);
        }
        fflush(stdout);
    }

    void test_cout_mixed_n() {
        for (int i = 0; i < ITERATIONS; ++i) {
            std::cout << "Int: " << test_int << ", Double: " << test_double
                << ", String: " << test_string << '\n';
        }
        std::cout.flush();
    }

    void test_cout_mixed_endl() {
        for (int i = 0; i < ITERATIONS; ++i) {
            std::cout << "Int: " << test_int << ", Double: " << test_double
                << ", String: " << test_string << std::endl;
        }
    }

    void test_write_console_mixed() {
        for (int i = 0; i < ITERATIONS; ++i) {
            std::string output = std::format("Int: {}, Double: {:.2f}, String: {}\n",
                test_int, test_double, test_string);
            write_output(output);
        }
    }

#if HAS_STD_PRINT
    void test_print_mixed() {
        for (int i = 0; i < ITERATIONS; ++i) {
            std::print("Int: {}, Double: {:.2f}, String: {}\n",
                test_int, test_double, test_string);
        }
    }
#endif

    // 自定义类型测试函数
    void test_cout_custom_n() {
        for (int i = 0; i < ITERATIONS; ++i) {
            std::cout << "Person: " << test_person.name << ", Age: " << test_person.age
                << ", Salary: " << test_person.salary << '\n';
        }
        std::cout.flush();
    }

    void test_cout_custom_endl() {
        for (int i = 0; i < ITERATIONS; ++i) {
            std::cout << "Person: " << test_person.name << ", Age: " << test_person.age
                << ", Salary: " << test_person.salary << std::endl;
        }
    }

    void test_write_console_custom() {
        for (int i = 0; i < ITERATIONS; ++i) {
            std::string output = std::format("Person: {}, Age: {}, Salary: {:.2f}\n",
                test_person.name, test_person.age, test_person.salary);
            write_output(output);
        }
    }

#if HAS_STD_PRINT
    void test_print_custom() {
        for (int i = 0; i < ITERATIONS; ++i) {
            std::print("Person: {}, Age: {}, Salary: {:.2f}\n",
                test_person.name, test_person.age, test_person.salary);
        }
    }
#endif

    // 平台特定的输出函数
    void write_output(const std::string& output) {
#ifdef _WIN32
        HANDLE hConsole = GetStdHandle(STD_OUTPUT_HANDLE);
        DWORD bytesWritten;
        WriteConsoleA(hConsole, output.c_str(), static_cast<DWORD>(output.length()),
            &bytesWritten, nullptr);
#else
        write(STDOUT_FILENO, output.c_str(), output.length());
#endif
    }
};

int main() {
    PerformanceTester tester;
    tester.run_all_tests();
    return 0;
}
```



## 测试结果分析

### 未定义 REDIRECT_OUTPUT（正常控制台输出）

```
--- 性能测试结果 (按时间排序) ---
WriteConsole/write (int)      :  151.551 ms (x1.00)
printf (string)               :  152.289 ms (x1.00)
printf (double)               :  154.929 ms (x1.02)
WriteConsole/write (string)   :  156.476 ms (x1.03)
WriteConsole/write (double)   :  157.694 ms (x1.04)
puts (string)                 :  159.361 ms (x1.05)
printf (int)                  :  163.472 ms (x1.08)
WriteConsole/write (custom)   :  174.727 ms (x1.15)
printf (mixed)                :  175.634 ms (x1.16)
WriteConsole/write (mixed)    :  176.744 ms (x1.17)
puts (double)                 :  182.778 ms (x1.21)
std::print (int)              :  258.660 ms (x1.71)
std::print (string)           :  259.507 ms (x1.71)
std::print (double)           :  261.719 ms (x1.73)
cout (string, endl)           :  267.152 ms (x1.76)
cout (string, \n)             :  271.830 ms (x1.79)
std::print (custom)           :  275.966 ms (x1.82)
std::print (mixed)            :  282.679 ms (x1.87)
cout (int, endl)              :  395.524 ms (x2.61)
cout (int, \n)                :  407.783 ms (x2.69)
cout (double, endl)           : 1001.199 ms (x6.61)
cout (double, \n)             : 1046.321 ms (x6.90)
puts (int)                    : 1057.853 ms (x6.98)
cout (custom, \n)             : 1772.962 ms (x11.70)
cout (custom, endl)           : 1775.414 ms (x11.71)
cout (mixed, \n)              : 1794.780 ms (x11.84)
cout (mixed, endl)            : 1802.026 ms (x11.89)

--- 按输出方式统计 ---
puts                :  466.664 ms (平均)
printf              :  161.581 ms (平均)
cout(\n)            : 1058.735 ms (平均)
cout(endl)          : 1048.263 ms (平均)
WriteConsole/write  :  163.438 ms (平均)
std::print          :  267.706 ms (平均)
========================================
```

**性能排序（从快到慢）：**
1. **WriteConsole/write** 和 **printf** 系列：150-180ms
2. **std::print**：~260ms
3. **cout (string)**：~270ms
4. **cout (int/double)**：400-1000ms
5. **puts (int)** 和复杂 cout：1050-1800ms

**按输出方式平均性能：**
- `printf`: 161.581 ms
- `WriteConsole/write`: 163.438 ms  
- `std::print`: 267.706 ms
- `puts`: 466.664 ms
- `cout(endl)`: 1048.263 ms
- `cout(\n)`: 1058.735 ms

### 定义 REDIRECT_OUTPUT（输出重定向到空设备）

```
--- 性能测试结果 (按时间排序) ---
cout (string, \n)             :    1.036 ms (x1.00)
cout (int, \n)                :    3.462 ms (x3.34)
cout (string, endl)           :    4.651 ms (x4.49)
cout (double, \n)             :    6.115 ms (x5.90)
cout (int, endl)              :    7.040 ms (x6.80)
cout (double, endl)           :   10.041 ms (x9.69)
cout (mixed, \n)              :   11.562 ms (x11.16)
cout (custom, \n)             :   11.692 ms (x11.29)
cout (mixed, endl)            :   15.826 ms (x15.28)
cout (custom, endl)           :   16.043 ms (x15.49)
puts (string)                 :  156.948 ms (x151.52)
printf (string)               :  159.255 ms (x153.75)
printf (int)                  :  159.368 ms (x153.86)
WriteConsole/write (string)   :  162.496 ms (x156.88)
WriteConsole/write (double)   :  163.274 ms (x157.63)
printf (double)               :  163.928 ms (x158.26)
WriteConsole/write (int)      :  168.269 ms (x162.45)
printf (mixed)                :  183.166 ms (x176.84)
puts (double)                 :  185.235 ms (x178.83)
WriteConsole/write (mixed)    :  186.106 ms (x179.67)
WriteConsole/write (custom)   :  188.295 ms (x181.79)
std::print (double)           :  276.920 ms (x267.35)
std::print (string)           :  277.867 ms (x268.26)
std::print (mixed)            :  286.686 ms (x276.78)
std::print (custom)           :  289.920 ms (x279.90)
std::print (int)              :  290.038 ms (x280.01)
puts (int)                    : 1204.630 ms (x1163.00)

--- 按输出方式统计 ---
puts                :  515.604 ms (平均)
printf              :  166.429 ms (平均)
cout(\n)            :    6.773 ms (平均)
cout(endl)          :   10.720 ms (平均)
WriteConsole/write  :  173.688 ms (平均)
std::print          :  284.286 ms (平均)
========================================
```

**性能发生巨大变化：**
- **cout 性能提升 150 倍以上**
- 其他输出方式性能基本保持不变

**按输出方式平均性能：**
- `cout(\n)`: 6.773 ms ⬆️ **提升 156 倍**
- `cout(endl)`: 10.720 ms ⬆️ **提升 98 倍**
- `printf`: 166.429 ms
- `WriteConsole/write`: 173.688 ms
- `std::print`: 284.286 ms
- `puts`: 515.604 ms

## 性能对比总结

### 正常控制台输出模式
1. **最佳性能**：`WriteConsole/write` 和 `printf`
2. **中等性能**：`std::print`（C++23 新特性）
3. **较差性能**：`cout` 和 `puts`（特定类型）

### 输出重定向模式
1. **绝对领先**：`cout`（重定向后性能最佳）
2. **稳定性能**：`printf` 和平台 API
3. **相对较慢**：`std::print` 和 `puts`

## REDIRECT_OUTPUT 对 cout 性能影响分析

### 根本原因：同步机制与缓冲策略

**1. 默认同步机制**
```cpp
// 默认情况下，cout 与 C 标准输出同步
std::ios_base::sync_with_stdio(true);
```
这保证了 C++ 和 C 的输出函数可以混合使用，但带来了性能开销。

**2. 缓冲策略差异**
- **控制台输出**：需要频繁的系统调用和终端渲染
- **文件/空设备输出**：大块写入，缓冲效率高

**3. 终端渲染开销**
控制台输出涉及：
- 字符编码转换
- 终端转义序列处理
- 屏幕刷新和光标移动
- 滚动处理

### 具体技术分析

**当 REDIRECT_OUTPUT 未定义时：**
```cpp
// cout 需要处理：
// 1. 与 printf 同步
// 2. 终端特性（颜色、光标位置等）
// 3. 逐字符或小缓冲输出
// 4. 系统调用频繁（每次输出都可能触发）
std::cout << data << '\n';  // 高开销
```

**当 REDIRECT_OUTPUT 定义时：**
```cpp
// 重定向到 /dev/null 或 NUL：
// 1. 大缓冲区写入（通常 4KB+）
// 2. 无终端渲染开销
// 3. 系统调用大幅减少
// 4. 纯内存操作，极快
std::cout.rdbuf(null_stream.rdbuf());  // 高性能
```

### 其他输出方式受影响较小的原因

**printf / puts：**
- 使用不同的缓冲策略
- 在大多数实现中已经针对控制台输出优化
- 缓冲机制与 cout 不同

**WriteConsole / write：**
- 直接系统调用，缓冲由系统处理
- 不受 C++ 流同步机制影响

**std::print：**
- C++23 新特性，实现可能还未充分优化
- 可能继承部分 cout 的开销

## 实际应用建议

### 高性能场景
1. **日志文件输出**：使用 `cout`（重定向到文件时性能优秀）
2. **控制台交互**：使用 `printf` 或平台特定 API
3. **格式化输出**：C++23 `std::print`（类型安全且性能可接受）

### 开发建议
```cpp
// 对于纯 C++ 输出，可关闭同步提升性能
std::ios_base::sync_with_stdio(false);

// 对于大量输出，使用 \n 而非 endl
std::cout << data << '\n';  // 更好的性能

// 手动控制刷新
std::cout.flush();  // 只在需要时刷新
```

## 结论

`REDIRECT_OUTPUT` 开启后 `cout` 性能大幅提升的根本原因在于**避免了控制台渲染的系统开销**和**利用了更高效的缓冲机制**。这揭示了 I/O 性能的关键因素：**目标设备的特性**往往比输出方法本身更重要。

在实际应用中，应根据输出目的地选择合适的输出方式：
- **控制台交互**：`printf` / 平台 API
- **文件/日志**：`cout`（性能优秀）
- **现代 C++**：`std::print`（平衡性能与安全性）

此测试充分证明了上下文环境对性能评估的重要性，不能孤立地比较不同输出方法的性能。